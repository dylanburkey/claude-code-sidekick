# Pre-commit Validation Workflow
# Quality gates that must pass before code can be pushed

name: Pre-commit Validation

on:
  push:
    branches-ignore:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: "20"
  PNPM_VERSION: "9"

jobs:
  pre-commit-checks:
    name: Pre-commit Quality Gates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          cache-dependency-path: "cli/pnpm-lock.yaml"

      - name: Install dependencies
        run: |
          pnpm install --frozen-lockfile
          cd cli && pnpm install --frozen-lockfile

      # Gate 1: No JavaScript syntax errors
      - name: Check for JavaScript errors
        run: |
          echo "üîç Checking for JavaScript syntax errors..."

          find cli/src cli/bin -name "*.js" -type f 2>/dev/null | while read file; do
            node --check "$file" 2>&1 || {
              echo "‚ùå Syntax error in: $file"
              exit 1
            }
          done

          echo "‚úÖ No JavaScript syntax errors found"

      # Gate 2: ESLint must pass
      - name: ESLint validation
        run: |
          echo "üîç Running ESLint..."
          pnpm lint || {
            echo "‚ùå ESLint found errors. Please fix them before pushing."
            exit 1
          }
          echo "‚úÖ ESLint passed"

      # Gate 3: JSDoc comments required
      - name: JSDoc validation
        run: |
          echo "üîç Checking JSDoc comments..."
          pnpm lint:jsdoc || {
            echo "‚ùå JSDoc comments missing or invalid. Please add documentation."
            exit 1
          }
          echo "‚úÖ JSDoc validation passed"

      # Gate 4: Code formatting
      - name: Prettier formatting check
        run: |
          echo "üîç Checking code formatting..."
          pnpm format:check || {
            echo "‚ùå Code is not properly formatted. Run 'pnpm format' to fix."
            exit 1
          }
          echo "‚úÖ Code formatting is correct"

      # Gate 5: YAML configuration validation
      - name: YAML validation
        run: |
          echo "üîç Validating YAML files..."

          npm install -g yaml-lint

          for file in $(find .claude -name "*.yml" -o -name "*.yaml"); do
            if [ -f "$file" ]; then
              yamllint "$file" || {
                echo "‚ùå Invalid YAML: $file"
                exit 1
              }
            fi
          done

          echo "‚úÖ All YAML files are valid"

      # Gate 6: CLI tests pass
      - name: Run CLI tests
        run: |
          echo "üîç Running CLI tests..."
          cd cli && pnpm test || {
            echo "‚ùå CLI tests failed"
            exit 1
          }
          echo "‚úÖ CLI tests passed"

      # Gate 7: Validate changed files
      - name: Validate changed files
        run: |
          echo "üîç Validating changed files..."

          # Get list of changed files
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
          else
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "")
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "No changed files to validate"
            exit 0
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Check for agent library changes
          AGENT_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^agent-library/' || true)
          if [ -n "$AGENT_CHANGES" ]; then
            echo "üìù Agent library files changed - validating structure"
          fi

          # Check for CLI changes
          CLI_CHANGES=$(echo "$CHANGED_FILES" | grep -E '^cli/' || true)
          if [ -n "$CLI_CHANGES" ]; then
            echo "üìù CLI files changed - tests already validated"
          fi

          # Check for config changes
          CONFIG_CHANGES=$(echo "$CHANGED_FILES" | grep -E '\.yml$|\.yaml$' || true)
          if [ -n "$CONFIG_CHANGES" ]; then
            echo "üìù Configuration files changed - YAML already validated"
          fi

          echo "‚úÖ All changed files validated"

      - name: Summary
        if: success()
        run: |
          echo "üéâ All pre-commit checks passed!"
          echo ""
          echo "Summary:"
          echo "  ‚úÖ JavaScript syntax valid"
          echo "  ‚úÖ ESLint passed"
          echo "  ‚úÖ JSDoc comments present"
          echo "  ‚úÖ Code properly formatted"
          echo "  ‚úÖ YAML configs valid"
          echo "  ‚úÖ CLI tests passed"
          echo ""
          echo "Your code is ready to be merged!"
